# .github/workflows/code-hygiene.yml
name: Code hygiene – TODO & 'use strict' audit

on:
  push:
    branches: [ main ]          
    paths-ignore:
      - '**.md'                 # optional: skip docs-only commits
  pull_request:
  schedule:
    - cron:  '0 3 * * *'        # nightly safety net (03:00 UTC)
permissions:
  contents: read
  issues: write

jobs:
  # ─────────────────────────────────────────────────────────────
  todo_issues:
    name: Create issues from TODO / FIXME
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Convert TODO comments to issues
        uses: alstr/todo-to-issue-action@v4
        with:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPEN_ISSUES: true                 # open new issues
          CLOSE_ISSUES: true                # auto-close when TODO removed
          COMMENT_MARKERS: 'TODO,FIXME'     # customise if needed
          EXCLUDED_FILES: |
            third_party/**
  # ─────────────────────────────────────────────────────────────
  strict_audit:
    name: Ensure 'use strict' in JS entry lines
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build report of offending files
        id: report
        run: |
          ROOT="js"                           # change as needed
          OUT=.github/_strict_report.md
          : > "$OUT"                           # truncate/create the file
  
          # collect offending files
          while IFS= read -r -d '' f; do
            first=$(head -n1 "$f" | tr -d '[:space:]')
            if [[ "$first" != "'usestrict';" && "$first" != "\"usestrict\";" ]]; then
              echo "- $f (missing 'use strict')" >> "$OUT"
            fi
          done < <(find "$ROOT" -type f -name "*.js" -print0)
  
          # expose output for later steps
          if [ -s "$OUT" ]; then
            echo "has_issues=true"  >> "$GITHUB_OUTPUT"
          else
            echo "has_issues=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Open / update GitHub issue
        if: steps.report.outputs.has_issues == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "JavaScript files without 'use strict'"
          content-filepath: .github/_strict_report.md
          token: ${{ secrets.GITHUB_TOKEN }}
          labels: "lint,missing-use-strict,automated"
          issue-number: 0                 # 0 = create or update by title
