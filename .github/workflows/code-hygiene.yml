# .github/workflows/code-hygiene.yml
name: Code hygiene – TODO & 'use strict' audit

on:
  push:
    branches: [ main ]
    paths-ignore: [ '**.md' ]
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues:   write          # let the default GITHUB_TOKEN open / edit issues

env:
  JS_ROOT: js              # change to your JS source folder

jobs:
# ─────────────── 1) TODO / FIXME → issues ───────────────
  todo_issues:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create / close TODO issues
        uses: alstr/todo-to-issue-action@v5.1.13
        with:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOSE_ISSUES: true
          INSERT_ISSUE_URLS: "true"
          IGNORE: |
            node_modules/**
            third_party/**

# ─────────────── 2) 'use strict' tracker ───────────────
  strict_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: build_report
        run: |
          OUT=.github/_strict_report.md
          : > "$OUT"
          find "$JS_ROOT" -type f -name '*.js' -print0 |
          while IFS= read -r -d '' file; do
            first=$(head -n1 "$file" | tr -d '[:space:]')
            if [[ "$first" != "'usestrict';" && "$first" != "\"usestrict\";" ]]; then
              echo "- $file" >> "$OUT"
            fi
          done
          echo "HAS_ISSUES=$( [[ -s $OUT ]] && echo true || echo false )" >> $GITHUB_ENV

      - name: Create / update tracking issue
        if: env.HAS_ISSUES == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "JavaScript files missing 'use strict'"
          content-filepath: .github/_strict_report.md
          labels: lint,missing-use-strict,automated
          issue-number: 0          # 0 = reuse open issue with same title
