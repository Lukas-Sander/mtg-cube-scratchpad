# .github/workflows/hygiene-report.yml
name: Code-hygiene report

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  issues:   write

env:
  BASE_URL: ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}

jobs:
  hygiene:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ------------ 1. Build the report ------------
      - id: scan
        run: |
          set -euo pipefail
          REPORT=.github/hygiene_report.md
          : > "$REPORT"
          
          echo "## TODO / FIXME" >> "$REPORT"
          todo_found=false
          grep -RInE \
               --exclude-dir={.git,.github,node_modules,third_party} \
               --exclude='*.md' \
               'TODO|FIXME' . | \
          while IFS=: read -r file line rest; do
            todo_found=true
            file=${file#./}                                # drop leading ./
            printf -- "- [`%s:%s`](%s/%s#L%s) %s\n" \
               "$file" "$line" "$BASE_URL" "$file" "$line" "$(echo "$rest" | sed 's/^ *//')" \
               >> "$REPORT"
          done || true
          $todo_found || echo "_No TODO/FIXME found_" >> "$REPORT"
          
          echo -e "\n## JS files missing 'use strict'" >> "$REPORT"
          strict_found=false
          find js -type f -name '*.js' ! -path './.github/*' -print0 2>/dev/null |
          while IFS= read -r -d '' f; do
            first=$(head -n1 "$f" | tr -d '[:space:]')
            if [[ "$first" != "'usestrict';" && "$first" != "\"usestrict\";" ]]; then
              strict_found=true
              f=${f#./}
              printf -- "- [`%s`](%s/%s)\n" "$f" "$BASE_URL" "$f" >> "$REPORT"
            fi
          done
          $strict_found || echo "_All clear_" >> "$REPORT"

          cat "$REPORT"

      # ------------ 2. Create or update the tracker issue ------------
      - name: Create / update single hygiene issue
        run: |
          set -euo pipefail
          TITLE="Code-hygiene report"
          LABEL="hygiene"

          NUM=$(gh issue list --state all --label "$LABEL" \
                 --search "$TITLE in:title" \
                 --json number --jq '.[0].number' || echo "")

          if [[ -n "$NUM" ]]; then
              echo "Updating existing issue #$NUM"
            gh issue edit "$NUM" \
              --body-file ".github/hygiene_report.md" \
              --add-label "$LABEL"
              gh issue reopen "$NUM" || true
          else
              echo "Creating new issue"
              gh issue create --title "$TITLE" \
                              --label "$LABEL" \
                              --body-file ".github/hygiene_report.md"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ------------ 3. Echo summary in the UI ------------
      - name: Add report to summary
        run: cat .github/hygiene_report.md >> $GITHUB_STEP_SUMMARY
