name: Hygiene-check (no side-effects)

on:
  # push:
    # branches: [ main ]
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan TODO / FIXME and 'use strict'
        run: |
          set -euo pipefail
          echo "## TODO / FIXME" >> $GITHUB_STEP_SUMMARY
          if ! grep -RInE --exclude-dir={.git,node_modules,third_party} 'TODO|FIXME' .; then
            echo "_No TODO/FIXME found_" >> $GITHUB_STEP_SUMMARY
          fi | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

          echo -e "\n## JS files missing 'use strict'" >> $GITHUB_STEP_SUMMARY
          missing=$(find js -type f -name '*.js' -exec awk 'FNR==1 {gsub(/[[:space:]]/, "", $0); if ($0 !~ /^('\''usestrict'\'';|"usestrict";)/) print FILENAME}' {} +)
          if [[ -z "$missing" ]]; then
            echo "_All clear_" >> $GITHUB_STEP_SUMMARY
          else
            printf '%s\n' "$missing" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          fi
